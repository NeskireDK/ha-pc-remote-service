using System.Diagnostics;
using HaPcRemote.Service.Configuration;
using HaPcRemote.Service.Logging;
using HaPcRemote.Service.Services;
using HaPcRemote.Tray.Logging;
using HaPcRemote.Tray.Models;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;

namespace HaPcRemote.Tray.Forms;

internal sealed class GeneralTab : TabPage
{
    private readonly IConfigurationWriter _configWriter;
    private readonly ToolTip _toolTip = new();
    private readonly ComboBox _logLevelCombo;
    private readonly CheckBox _autoUpdateCheck;
    private readonly NumericUpDown _portInput;
    private readonly Label _portStatusLabel;
    private readonly Button _portSaveButton;
    private readonly Label _soundVolumeViewLabel;
    private readonly Label _multiMonitorToolLabel;
    private readonly int _currentPort;

    public GeneralTab(IServiceProvider services)
    {
        Text = "General";
        BackColor = Color.FromArgb(30, 30, 30);
        ForeColor = Color.White;
        Padding = new Padding(20);

        _configWriter = services.GetRequiredService<IConfigurationWriter>();
        var options = services.GetRequiredService<IOptions<PcRemoteOptions>>().Value;
        _currentPort = options.Port;

        var layout = new TableLayoutPanel
        {
            Dock = DockStyle.Top,
            AutoSize = true,
            ColumnCount = 2,
            Padding = new Padding(0, 10, 0, 0)
        };
        layout.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 150));
        layout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100));

        int row = 0;

        // Port input + status
        var portPanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        _portInput = new NumericUpDown
        {
            Minimum = 1024,
            Maximum = 65535,
            Value = _currentPort,
            Width = 80,
            BackColor = Color.FromArgb(50, 50, 50),
            ForeColor = Color.White
        };
        _portStatusLabel = new Label { AutoSize = true, Padding = new Padding(5, 3, 0, 0) };
        _portSaveButton = new Button
        {
            Text = "Save & Restart",
            FlatStyle = FlatStyle.Flat,
            BackColor = Color.FromArgb(50, 50, 50),
            ForeColor = Color.White,
            AutoSize = true,
            Visible = false,
            Cursor = Cursors.Hand
        };
        _portSaveButton.Click += OnPortSave;
        _portInput.ValueChanged += (_, _) =>
        {
            _portSaveButton.Visible = (int)_portInput.Value != _currentPort;
        };
        portPanel.Controls.Add(_portInput);
        portPanel.Controls.Add(_portStatusLabel);
        portPanel.Controls.Add(_portSaveButton);
        portPanel.Controls.Add(MakeHelpIcon(_toolTip,
            "HTTP port the service listens on.\n" +
            "Home Assistant must be configured with the same port.\n" +
            "Changes require a restart. Valid range: 1024–65535."));
        layout.Controls.Add(MakeLabel("Port:"), 0, row);
        layout.Controls.Add(portPanel, 1, row++);
        UpdatePortStatus();

        // NirSoft tools status
        _soundVolumeViewLabel = new Label { AutoSize = true, Anchor = AnchorStyles.Left };
        var svvPanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        svvPanel.Controls.Add(_soundVolumeViewLabel);
        svvPanel.Controls.Add(MakeHelpIcon(_toolTip,
            "NirSoft SoundVolumeView — required for audio device switching.\n" +
            "Must be placed in the configured ToolsPath directory.\n" +
            "Download: nirsoft.net/utils/sound_volume_view.html"));
        layout.Controls.Add(MakeLabel("SoundVolumeView:"), 0, row);
        layout.Controls.Add(svvPanel, 1, row++);

        _multiMonitorToolLabel = new Label { AutoSize = true, Anchor = AnchorStyles.Left };
        var mmtPanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        mmtPanel.Controls.Add(_multiMonitorToolLabel);
        mmtPanel.Controls.Add(MakeHelpIcon(_toolTip,
            "NirSoft MultiMonitorTool — required for monitor profile switching.\n" +
            "Must be placed in the configured ToolsPath directory.\n" +
            "Download: nirsoft.net/utils/multi_monitor_tool.html"));
        layout.Controls.Add(MakeLabel("MultiMonitorTool:"), 0, row);
        layout.Controls.Add(mmtPanel, 1, row++);

        UpdateToolStatus(_soundVolumeViewLabel, Path.Combine(options.ToolsPath, "SoundVolumeView.exe"));
        UpdateToolStatus(_multiMonitorToolLabel, Path.Combine(options.ToolsPath, "MultiMonitorTool.exe"));

        // Separator
        layout.Controls.Add(new Label { AutoSize = true, Height = 10 }, 0, row++);

        // Log level
        _logLevelCombo = new ComboBox
        {
            DropDownStyle = ComboBoxStyle.DropDownList,
            Width = 200,
            BackColor = Color.FromArgb(50, 50, 50),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        _logLevelCombo.Items.AddRange(["Error", "Warning", "Info", "Verbose"]);

        var settings = TraySettings.Load();
        _logLevelCombo.SelectedItem = settings.LogLevel switch
        {
            "Error" => "Error",
            "Info" => "Info",
            "Verbose" => "Verbose",
            _ => "Warning"
        };
        var logPanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        logPanel.Controls.Add(_logLevelCombo);
        logPanel.Controls.Add(MakeHelpIcon(_toolTip,
            "Controls how much detail is written to the log.\n" +
            "Error: only failures\n" +
            "Warning: failures and unexpected conditions\n" +
            "Info: normal operational events (recommended)\n" +
            "Verbose: full request/response detail (for debugging)"));
        layout.Controls.Add(MakeLabel("Log Level:"), 0, row);
        layout.Controls.Add(logPanel, 1, row++);

        // Auto-update
        _autoUpdateCheck = new CheckBox
        {
            Text = "Auto Update",
            ForeColor = Color.White,
            AutoSize = true,
            Checked = settings.AutoUpdate
        };
        _toolTip.SetToolTip(_autoUpdateCheck,
            "Automatically download and install new service releases from GitHub.\n" +
            "The tray icon will notify you before restarting.");

        var autoUpdatePanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        autoUpdatePanel.Controls.Add(_autoUpdateCheck);
        autoUpdatePanel.Controls.Add(MakeHelpIcon(_toolTip,
            "Automatically download and install new service releases from GitHub.\n" +
            "The tray icon will notify you before restarting."));

        layout.Controls.Add(new Label { AutoSize = true }, 0, row);
        layout.Controls.Add(autoUpdatePanel, 1, row++);

        // Apply + Cancel buttons
        var applyButton = new Button { Text = "Apply", FlatStyle = FlatStyle.Flat, BackColor = Color.FromArgb(50, 130, 50), ForeColor = Color.White, Size = new Size(80, 28), Cursor = Cursors.Hand };
        var cancelButton = new Button { Text = "Cancel", FlatStyle = FlatStyle.Flat, BackColor = Color.FromArgb(50, 50, 50), ForeColor = Color.White, Size = new Size(80, 28), Cursor = Cursors.Hand };
        applyButton.Click += OnApply;
        cancelButton.Click += OnCancel;
        var buttonPanel = new FlowLayoutPanel { FlowDirection = FlowDirection.LeftToRight, AutoSize = true };
        buttonPanel.Controls.Add(applyButton);
        buttonPanel.Controls.Add(cancelButton);
        layout.Controls.Add(new Label(), 0, row);
        layout.Controls.Add(buttonPanel, 1, row);

        Controls.Add(layout);
    }

    private void UpdatePortStatus()
    {
        if (KestrelStatus.Started.IsCompleted)
        {
            ApplyPortStatus();
            return;
        }

        _portStatusLabel.Text = "starting...";
        _portStatusLabel.ForeColor = Color.Orange;

        _ = Task.Run(async () =>
        {
            await KestrelStatus.Started;
            BeginInvoke(ApplyPortStatus);
        });
    }

    private void ApplyPortStatus()
    {
        if (KestrelStatus.IsRunning)
        {
            _portStatusLabel.Text = "listening";
            _portStatusLabel.ForeColor = Color.LightGreen;
        }
        else
        {
            _portStatusLabel.Text = $"failed: {KestrelStatus.Error}";
            _portStatusLabel.ForeColor = Color.Salmon;
            _portSaveButton.Visible = true;
        }
    }

    private void OnPortSave(object? sender, EventArgs e)
    {
        var newPort = (int)_portInput.Value;
        if (MessageBox.Show(
                $"Change port to {newPort} and restart the application?",
                "Confirm Restart",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question) != DialogResult.Yes)
            return;

        _configWriter.SavePort(newPort);
        var exePath = Environment.ProcessPath
            ?? throw new InvalidOperationException("Cannot determine process path for restart.");
        Process.Start(new ProcessStartInfo(exePath) { UseShellExecute = true });
        Application.Exit();
    }

    private static void UpdateToolStatus(Label label, string toolPath)
    {
        if (File.Exists(toolPath))
        {
            label.Text = "Found";
            label.ForeColor = Color.LightGreen;
        }
        else
        {
            label.Text = $"Missing — expected at {toolPath}";
            label.ForeColor = Color.Salmon;
        }
    }

    private static Label MakeLabel(string text) => new()
    {
        Text = text,
        ForeColor = Color.White,
        AutoSize = true,
        Anchor = AnchorStyles.Left,
        Padding = new Padding(0, 3, 0, 0)
    };

    private static Label MakeHelpIcon(ToolTip toolTip, string helpText)
    {
        var label = new Label
        {
            Text = "ⓘ",
            ForeColor = Color.FromArgb(120, 180, 255),
            AutoSize = true,
            Cursor = Cursors.Help,
            Padding = new Padding(4, 4, 0, 0),
            Font = new Font("Segoe UI", 9f)
        };
        toolTip.SetToolTip(label, helpText);
        label.Click += (_, _) => toolTip.Show(helpText, label, 3000);
        return label;
    }

    private void OnApply(object? sender, EventArgs e)
    {
        var level = _logLevelCombo.SelectedItem?.ToString() ?? "Warning";
        var logLevel = level switch
        {
            "Error" => LogLevel.Error,
            "Info" => LogLevel.Information,
            "Verbose" => LogLevel.Debug,
            _ => LogLevel.Warning
        };

        InMemoryLogProvider.MinimumLevel = logLevel;
        FileLoggerProvider.MinimumLevel = logLevel;

        var s = TraySettings.Load();
        s.LogLevel = level;
        s.AutoUpdate = _autoUpdateCheck.Checked;
        s.Save();
    }

    private void OnCancel(object? sender, EventArgs e)
    {
        var s = TraySettings.Load();
        _logLevelCombo.SelectedItem = s.LogLevel switch
        {
            "Error" => "Error",
            "Info" => "Info",
            "Verbose" => "Verbose",
            _ => "Warning"
        };
        _autoUpdateCheck.Checked = s.AutoUpdate;
    }
}
