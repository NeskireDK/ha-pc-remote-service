# ha-windows-remote-service

A lightweight Windows Service (Native AOT) that exposes a REST API for controlling audio, monitors, apps, and system power on a Windows PC. Designed for use with the [ha-windows-remote](https://github.com/NeskireDK/ha-windows-remote) Home Assistant integration.

## Project Structure

```
ha-windows-remote-service/
  HaWindowsRemote.sln
  src/
    HaWindowsRemote.Service/
      Program.cs                          # Entry point, DI, middleware, endpoints
      AppJsonContext.cs                   # JSON source generator (AOT-safe)
      Configuration/
        PcRemoteOptions.cs                # Strongly-typed config binding
      Endpoints/
        HealthEndpoints.cs                # GET /api/health
        SystemEndpoints.cs                # POST /api/system/sleep
      Middleware/
        ApiKeyMiddleware.cs               # X-Api-Key header validation
      Models/
        ApiResponse.cs                    # Standard API response wrapper
        HealthResponse.cs                 # Health check response
      Services/
        ApiKeyService.cs                  # Key generation + config persistence
        IPowerService.cs                  # Platform abstraction for power mgmt
        WindowsPowerService.cs            # Windows P/Invoke SetSuspendState
```

## Quick Start

1. Download the latest release
2. Place NirSoft tools in `./tools/` (optional, for audio/monitor control)
3. Run the exe once to generate `appsettings.json` with your API key
4. Install as a Windows Service:
   ```powershell
   sc create HaWindowsRemote binPath="C:\path\to\HaWindowsRemote.Service.exe"
   sc start HaWindowsRemote
   ```

## Configuration

`appsettings.json` is auto-generated on first run with a random API key:

```json
{
  "PcRemote": {
    "Port": 5000,
    "Auth": {
      "Enabled": true,
      "ApiKey": "<auto-generated>"
    },
    "ToolsPath": "./tools",
    "ProfilesPath": "./profiles"
  }
}
```

## API

All endpoints except `/api/health` require the `X-Api-Key` header.

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/health` | Health check (no auth) |
| `POST` | `/api/system/sleep` | Suspend the PC |

## Building

```bash
dotnet build HaWindowsRemote.sln
dotnet publish src/HaWindowsRemote.Service -c Release -r win-x64
```

## License

MIT
