# ha-pc-remote-service

A lightweight Windows Service (Native AOT) that exposes a REST API for controlling a Windows PC. Designed for use with the [ha-pc-remote](https://github.com/NeskireDK/ha-pc-remote) Home Assistant integration.

## Quick Start

1. Download the latest release from [Releases](https://github.com/NeskireDK/ha-pc-remote-service/releases)
2. Place [NirSoft tools](#nirsoft-tools) in a `tools/` folder next to the exe
3. Run the exe once — it auto-generates `appsettings.json` with a random API key
4. Install as a Windows Service:
   ```powershell
   sc create HaPcRemote binPath="C:\path\to\HaPcRemote.Service.exe"
   sc start HaPcRemote
   ```

The service advertises itself via mDNS (`_pc-remote._tcp`) for auto-discovery by the HA integration.

## API Endpoints

All endpoints except `/api/health` require the `X-Api-Key` header.

### Health

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/health` | Health check (no auth) |

### System

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/api/system/sleep` | Suspend the PC |
| `GET` | `/api/system/mac` | List MAC addresses of active network interfaces |
| `POST` | `/api/system/wol/{mac}` | Send Wake-on-LAN magic packet to a MAC address |

### Audio

Requires `SoundVolumeView.exe` in `ToolsPath`.

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/audio/devices` | List audio output devices |
| `GET` | `/api/audio/current` | Current default output device |
| `POST` | `/api/audio/set/{deviceName}` | Switch default output device |
| `POST` | `/api/audio/volume/{level}` | Set master volume (0-100) |

### Monitors — Direct Control

Requires `MultiMonitorTool.exe` in `ToolsPath`.

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/monitor/list` | List connected monitors |
| `POST` | `/api/monitor/solo/{id}` | Enable only this monitor, disable all others |
| `POST` | `/api/monitor/enable/{id}` | Enable a monitor |
| `POST` | `/api/monitor/disable/{id}` | Disable a monitor |
| `POST` | `/api/monitor/primary/{id}` | Set a monitor as primary |

### Monitors — Profiles

Profile `.cfg` files are saved in `ProfilesPath` (created with MultiMonitorTool).

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/monitor/profiles` | List saved monitor profiles |
| `POST` | `/api/monitor/set/{profile}` | Apply a monitor profile |

### Apps

Apps are defined in `appsettings.json` under `PcRemote.Apps`.

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/app/status` | Status of all configured apps |
| `GET` | `/api/app/status/{appKey}` | Status of a specific app |
| `POST` | `/api/app/launch/{appKey}` | Launch a configured app |
| `POST` | `/api/app/kill/{appKey}` | Kill a configured app |

## Configuration

Runtime-generated settings (API key) are stored in `%ProgramData%\HaPcRemote\appsettings.json` so the service works correctly when installed in read-only locations like `C:\Program Files`. Static configuration is read from `appsettings.json` next to the executable; the ProgramData file overrides matching values.

Full example:

```json
{
  "PcRemote": {
    "Port": 5000,
    "Auth": {
      "Enabled": true,
      "ApiKey": "<auto-generated>"
    },
    "ToolsPath": "./tools",
    "ProfilesPath": "./monitor-profiles",
    "Apps": {
      "steam-bigpicture": {
        "DisplayName": "Steam Big Picture",
        "ExePath": "C:\\Program Files (x86)\\Steam\\steam.exe",
        "Arguments": "steam://open/bigpicture",
        "ProcessName": "steam"
      }
    }
  }
}
```

| Key | Default | Description |
|-----|---------|-------------|
| `Port` | `5000` | HTTP listen port |
| `Auth.Enabled` | `true` | Require `X-Api-Key` header |
| `Auth.ApiKey` | (generated) | API key, auto-generated on first run |
| `ToolsPath` | `./tools` | Directory containing NirSoft executables |
| `ProfilesPath` | `./monitor-profiles` | Directory containing monitor profile `.cfg` files |
| `Apps` | `{}` | Map of app key to app definition |

### App Definition

| Key | Required | Description |
|-----|----------|-------------|
| `DisplayName` | Yes | Friendly name shown in HA |
| `ExePath` | Yes | Full path to the executable |
| `Arguments` | No | Command-line arguments |
| `ProcessName` | Yes | Process name used to detect if the app is running |

## NirSoft Tools

Two free NirSoft tools are required. Place them in the `ToolsPath` directory (default: `./tools`).

- **[SoundVolumeView](https://www.nirsoft.net/utils/sound_volume_view.html)** — used for audio device listing, switching, and volume control
- **[MultiMonitorTool](https://www.nirsoft.net/utils/multi_monitor_tool.html)** — used for monitor listing, enable/disable, and profile management

## Building

```bash
dotnet build HaPcRemote.sln
dotnet test HaPcRemote.sln
dotnet publish src/HaPcRemote.Service -c Release -r win-x64 /p:PublishAot=true
```

## License

MIT
